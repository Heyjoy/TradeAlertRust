# 交易预警系统开发计划

## 项目概述
开发一个实时交易预警系统，用于监控股票价格并在达到预设条件时发出提醒。

## 技术栈
- 后端：Rust + Axum（已从 Actix-web 迁移）
- 数据库：SQLite（后期可迁移到PostgreSQL）
- 前端：HTML5 + CSS3 + JavaScript
  - 使用 Askama 作为模板引擎
  - 使用 Bootstrap 进行样式设计
- 实时通信：WebSocket（用于价格更新和通知）
- 定时任务：tokio-cron-scheduler
- 行情数据源：Yahoo Finance API

## 功能模块

### 1. 预警管理模块
- [x] 预警模型定义
- [x] 数据库设计和迁移
- [x] RESTful API实现
  - [x] 创建预警
  - [x] 获取预警列表
  - [x] 获取单个预警
  - [x] 删除预警
  - [x] 更新预警状态
- [ ] 预警编辑功能
  - [x] API实现
  - [ ] UI交互优化
- [x] 预警状态管理
  - [x] 状态定义
  - [x] 状态转换
  - [ ] UI状态展示优化
- [x] 预警触发历史记录
  - [x] 数据库记录
  - [ ] 历史记录展示
- [ ] 预警条件验证
- [ ] 预警类型支持
  - [ ] 目标价区间提醒
    * [ ] 支持设置价格区间（上下限）
    * [ ] 区间内触发提醒
    * [ ] 区间外状态显示
  - [ ] 预测性预警
    * [ ] 支持设置接近度阈值（如5%-10%）
    * [ ] 计算当前价格与目标区间的距离
    * [ ] 接近阈值时发送预警
  - [ ] 预警级别管理
    * [ ] 普通提醒（达到目标价）
    * [ ] 预警提醒（接近目标价）
    * [ ] 不同级别的通知方式

### 2. 价格监控模块
- [ ] 实时价格数据获取
  - [ ] Yahoo Finance API 集成
  - [ ] 数据获取重试机制
  - [ ] 实时价格缓存
    * [ ] 内存缓存机制
    * [ ] 缓存更新策略
    * [ ] 缓存失效处理
- [x] 价格数据存储
  - [x] 基础价格记录
  - [ ] 历史价格记录
  - [ ] 数据清理策略
  - [ ] 价格快照功能
    * [ ] 定时价格快照
    * [ ] 价格变动记录
    * [ ] 价格波动统计
- [x] 价格更新服务
  - [x] 定时更新任务
    * [x] 基础轮询更新（30秒间隔）
    * [x] 更新频率配置
    * [ ] 更新状态监控
  - [ ] 价格数据API
    * [ ] RESTful 价格查询接口
    * [ ] 批量价格查询
    * [ ] 价格历史查询
  - [ ] 后期优化（第二阶段）
    * [ ] WebSocket 实时推送
    * [ ] 价格变动通知
    * [ ] 更新状态监控

### 3. 用户界面模块
- [x] 基础模板开发
  - [x] 通用布局（base.html）
  - [x] 导航栏
  - [x] 响应式设计
- [x] 预警管理界面
  - [x] 预警列表页面（index.html）
  - [x] 创建预警表单（alert_form.html）
    * [x] 基础表单布局
    * [ ] 目标价区间设置
    * [ ] 预测预警阈值设置
    * [ ] 预警级别选择
  - [ ] 编辑预警界面
    * [x] 基础编辑功能
    * [ ] 表单验证优化
    * [ ] 用户交互优化
  - [ ] 删除确认对话框
- [ ] 实时数据展示
  - [ ] 价格更新机制
    * [ ] 页面定时刷新（30秒）
    * [ ] Ajax轮询更新
    * [ ] 更新状态指示
  - [ ] 价格实时更新
    * [ ] 当前价格大字体显示
    * [ ] 价格变动箭头指示
    * [ ] 涨跌幅百分比
  - [ ] 价格趋势图表
    * [ ] 基础K线图（定时更新）
    * [ ] 分时图
    * [ ] 成交量图表
  - [ ] 后期优化（第二阶段）
    * [ ] WebSocket实时图表
    * [ ] 实时数据推送
    * [ ] 动态更新优化
  - [ ] 价格信息面板
    * [ ] 日内最高/最低价
    * [ ] 开盘价/昨收价
    * [ ] 成交量信息
  - [ ] 预警状态指示器
    * [ ] 目标价区间显示
    * [ ] 接近度指示器
    * [ ] 预警级别标识
  - [ ] 触发通知显示
  - [ ] 预测信息展示
    * [ ] 当前接近度显示
    * [ ] 趋势预测图表
    * [ ] 预警概率指示
- [ ] 价格监控页面
  - [ ] 价格概览面板
    * [ ] 多股票价格列表
    * [ ] 价格变动排序
    * [ ] 快速预警设置
  - [ ] 详细价格页面
    * [ ] 完整价格信息
    * [ ] 历史价格图表
    * [ ] 技术指标显示
  - [ ] 价格提醒设置
    * [ ] 价格区间设置
    * [ ] 变动提醒设置
    * [ ] 自定义提醒规则

### 4. 通知系统模块
- [ ] 邮件通知
  - [ ] SMTP 服务集成
  - [ ] 邮件模板
    * [ ] 目标价提醒模板
    * [ ] 预测预警模板
  - [ ] 发送状态跟踪
- [ ] 网页通知
  - [ ] WebSocket 实现
  - [ ] 浏览器通知
  - [ ] 通知历史记录
- [ ] 移动端通知
  - [ ] 短信通知集成
  - [ ] 推送通知服务
  - [ ] 通知优先级管理

### 5. 测试模块
- [x] API测试脚本
- [ ] 单元测试
  - [ ] 模型测试
  - [ ] 服务测试
  - [ ] 工具函数测试
- [ ] 集成测试
  - [ ] API 集成测试
  - [ ] 数据库操作测试
- [ ] 端到端测试
- [ ] 性能测试
  - [ ] 并发测试
  - [ ] 负载测试
- [ ] 用户界面测试

## 开发阶段

### 第一阶段：基础功能实现（当前阶段）
- [x] 项目初始化
- [x] 数据库设计
- [x] 基础API实现
- [x] API测试脚本
- [x] 基础网页界面
  - [x] 预警列表显示
  - [x] 创建预警表单
  - [x] 基本的CRUD操作界面
  - [ ] 基础价格显示
    * [ ] 定时刷新页面
    * [ ] Ajax轮询更新
    * [ ] 简单价格图表
  - [ ] UI优化
    * [ ] 删除确认对话框改进
    * [ ] 预警编辑交互优化
    * [ ] 预警状态展示优化
  - [ ] 价格历史功能
    * [ ] 历史数据查询API
    * [ ] 历史数据展示界面
    * [ ] 基础图表展示

### 第二阶段：实时功能实现（调整后）
- [ ] 价格数据服务
  - [ ] Yahoo Finance API 集成
  - [ ] 数据获取和存储优化
  - [ ] 缓存机制实现
- [ ] 实时更新机制
  - [ ] 基础轮询实现
    * [ ] 页面定时刷新优化
    * [ ] Ajax轮询优化
    * [ ] 更新状态管理
  - [ ] WebSocket实现（可选）
    * [ ] WebSocket服务
    * [ ] 实时推送
    * [ ] 连接管理
- [ ] 预警触发系统优化
  - [ ] 条件检查逻辑优化
  - [ ] 触发处理优化
- [ ] 基础通知系统
  - [ ] 网页通知
  - [ ] 通知历史记录

### 第三阶段：功能优化和增强（调整后）
- [ ] 用户界面优化
  - [ ] 响应式设计完善
  - [ ] 交互体验提升
  - [ ] 图表展示优化
- [ ] 性能优化
  - [ ] 数据库查询优化
  - [ ] 缓存机制优化
  - [ ] 前端性能优化
- [ ] 高级通知系统
  - [ ] 邮件通知
  - [ ] 通知优先级管理
- [ ] 错误处理和日志
  - [ ] 错误日志系统
  - [ ] 用户提示优化
  - [ ] 性能监控

### 第四阶段：部署和维护（保持不变）
- [ ] 部署文档
  - [ ] 环境要求
  - [ ] 部署步骤
  - [ ] 配置说明
- [ ] 用户手册
  - [ ] 功能说明
  - [ ] 使用指南
  - [ ] 常见问题
- [ ] 维护计划
  - [ ] 日常维护
  - [ ] 数据备份
  - [ ] 系统更新
- [ ] 性能监控
  - [ ] 监控指标
  - [ ] 告警规则
- [ ] 备份策略
  - [ ] 数据备份
  - [ ] 配置备份
  - [ ] 恢复方案

## 当前进度
✅ 已完成：
1. 基础项目结构搭建
   - 项目框架迁移到 Axum
   - 配置系统实现
   - 数据库迁移系统
2. 数据库设计和迁移
   - 完整的 alerts 表结构
   - 必要的索引创建
   - 数据库操作封装
3. 预警模型定义
   - Alert 结构体定义
   - AlertCondition 和 AlertStatus 枚举
   - 完整的 CRUD 操作支持
   - 预警触发逻辑实现
4. RESTful API 实现
   - 创建预警
   - 获取预警列表
   - 获取单个预警
   - 删除预警
   - 更新预警状态
   - 预警触发处理
5. 基础用户界面
   - 基础模板系统 (base.html)
   - 预警列表页面 (index.html)
   - 预警创建/编辑表单 (alert_form.html)
   - 响应式设计
   - 基础交互功能
6. 价格监控基础
   - 价格检查逻辑
   - 预警触发机制
   - 定时任务配置
   - 基础价格数据获取

🔄 进行中：
1. 预警管理模块完善
   - 预警编辑功能（API已实现，UI部分完成）
   - 预警状态管理（基础实现完成）
   - 预警触发历史记录（基础实现完成）
   - UI优化（进行中）
     * 删除确认对话框改进
     * 预警编辑交互优化
     * 预警状态展示优化
2. 价格监控模块
   - 价格历史查询功能（开发中）
   - 基础价格显示优化（计划中）
   - 实时更新机制（计划中）

## 下一步计划
1. 完成UI优化
   - 实现删除确认对话框的模态框
   - 优化预警编辑的用户交互
   - 改进预警状态展示
   - 添加操作反馈提示

2. 实现价格历史功能
   - 开发历史数据查询API
   - 实现历史数据展示界面
   - 添加基础图表展示
   - 优化数据加载性能

3. 开始实时功能开发
   - 集成 Yahoo Finance API
   - 实现数据获取和存储优化
   - 开发基础轮询更新机制
   - 实现基础通知系统

## 时间线调整
- 第一阶段（基础功能）：2周（已完成大部分）
  * 新增：UI优化（+0.5周）
  * 新增：价格历史功能（+0.5周）
- 第二阶段（实时功能）：2周（进行中）
  * 简化：基础通知系统（-0.5周）
  * 新增：WebSocket实现（可选，+0.5周）
- 第三阶段（优化增强）：1.5周（计划中）
  * 新增：高级通知系统（+0.5周）
- 第四阶段（部署维护）：1周（计划中）

总计预计开发时间：6.5-8周（比原计划缩短0.5-2周）

## 注意事项
1. 确保代码质量和可维护性
2. 保持文档的及时更新
3. 注重用户体验
4. 重视测试覆盖
5. 考虑后期扩展性
6. 关注实时数据获取的可靠性
7. 重视系统性能优化

## 风险管理
1. 技术风险
   - 实时数据获取的可靠性
   - 轮询更新的性能影响
   - 数据库性能优化
   - 预测算法的准确性
   - 后期WebSocket迁移
2. 业务风险
   - 价格数据的准确性
   - 通知的及时性
   - 用户体验的保证
   - 预测预警的误报率
3. 运维风险
   - 系统监控
   - 数据备份
   - 错误恢复 