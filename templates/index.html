{% extends "base.html" %}

{% block title %}预警列表 - 交易预警系统{% endblock %}

{% block extra_css %}
<style>
    .alert-card {
        margin-bottom: 1rem;
    }

    .alert-card .card-header {
        background-color: white;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        padding: 1rem;
    }

    .alert-card .card-body {
        padding: 1rem;
    }

    .alert-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .alert-info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .alert-info-item i {
        color: var(--secondary-color);
    }

    .alert-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .price-change {
        font-weight: 500;
    }

    .price-change.up {
        color: var(--success-color);
    }

    .price-change.down {
        color: var(--danger-color);
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .empty-state i {
        font-size: 3rem;
        color: var(--secondary-color);
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #666;
        margin-bottom: 1.5rem;
    }

    .refresh-button {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        background-color: var(--accent-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: transform 0.2s ease;
    }

    .refresh-button:hover {
        transform: rotate(180deg);
        color: white;
    }

    @media (max-width: 768px) {
        .alert-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .alert-actions {
            flex-direction: column;
        }

        .alert-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">预警列表</h1>
    <a href="/alerts/new" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i>创建预警
    </a>
</div>

{% if !alerts.is_empty() %}
    <div class="row">
        {% for alert in alerts %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card alert-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>{{ alert.symbol }}
                    </h5>
                    <span class="alert-status {{ alert.status }}">
                        {% if alert.status == "active" %}
                            活跃
                        {% else if alert.status == "triggered" %}
                            已触发
                        {% else %}
                            已取消
                        {% endif %}
                    </span>
                </div>
                <div class="card-body">
                    <div class="alert-info">
                        <div class="alert-info-item">
                            <i class="fas fa-bullseye"></i>
                            <span>{{ alert.condition }} {{ alert.price }}</span>
                        </div>
                        <div class="alert-info-item">
                            <i class="fas fa-clock"></i>
                            <span>创建于 {{ alert.created_at }}</span>
                        </div>
                        {% if alert.triggered_at.is_some() %}
                        <div class="alert-info-item">
                            <i class="fas fa-bell"></i>
                            <span>触发于 {{ alert.triggered_at.unwrap() }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="alert-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="editAlert({{ alert.id }})">
                            <i class="fas fa-edit me-1"></i>编辑
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteAlert({{ alert.id }})">
                            <i class="fas fa-trash me-1"></i>删除
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <i class="fas fa-bell-slash"></i>
        <h3>暂无预警</h3>
        <p>创建您的第一个价格预警，开始监控股票价格</p>
        <a href="/alerts/new" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>创建预警
        </a>
    </div>
{% endif %}

<a href="#" class="refresh-button" onclick="refreshAlerts()" title="刷新预警列表">
    <i class="fas fa-sync-alt"></i>
</a>
{% endblock %}

{% block extra_js %}
<script>
    // 编辑预警
    function editAlert(id) {
        window.location.href = `/alerts/${id}/edit`;
    }

    // 删除预警
    function deleteAlert(id) {
        confirmAction('确定要删除这个预警吗？', function() {
            showLoading();
            $.ajax({
                url: `/api/alerts/${id}`,
                method: 'DELETE',
                success: function() {
                    showToast('预警已删除');
                    // 刷新页面或移除对应的卡片
                    location.reload();
                },
                error: function(xhr) {
                    showToast('删除失败: ' + (xhr.responseJSON?.message || '未知错误'), 'danger');
                },
                complete: function() {
                    hideLoading();
                }
            });
        });
    }

    // 刷新预警列表
    function refreshAlerts() {
        showLoading();
        $.ajax({
            url: '/api/alerts',
            method: 'GET',
            success: function(data) {
                // 这里可以优化为只更新变化的部分，而不是刷新整个页面
                location.reload();
            },
            error: function(xhr) {
                showToast('刷新失败: ' + (xhr.responseJSON?.message || '未知错误'), 'danger');
            },
            complete: function() {
                hideLoading();
            }
        });
    }

    // 自动刷新（每30秒）
    let refreshInterval = setInterval(refreshAlerts, 30000);

    // 页面卸载时清除定时器
    $(window).on('unload', function() {
        clearInterval(refreshInterval);
    });
</script>
{% endblock %} 